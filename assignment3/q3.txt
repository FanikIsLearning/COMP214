
--Q3
CREATE OR REPLACE PROCEDURE PROMO_SHIP_SP (p_date IN DATE) IS
    HOI_MONTH CHAR(3) := 'APR';
    HOI_YEAR NUMBER(4,0) := 2012;
    HOI_PROMOFLAG NUMBER(1,0) := 1;
    HOI_USED CHAR(1);
    
    CURSOR HOI_LIST_CUR IS 
        SELECT IDSHOPPER, MAX(DTCREATED) CREATEDATE, ORDERPLACED
        FROM BB_BASKET
        GROUP BY IDSHOPPER, ORDERPLACED
        HAVING MAX(DTCREATED) < p_date;
    
    HOI_LIST HOI_LIST_CUR%ROWTYPE;
BEGIN
    OPEN HOI_LIST_CUR;
    FETCH HOI_LIST_CUR INTO HOI_LIST;

    WHILE HOI_LIST_CUR%FOUND LOOP
        IF HOI_LIST.ORDERPLACED = 1 THEN
            HOI_USED := 'Y';
        ELSE
            HOI_USED := 'N';
        END IF;

        INSERT INTO bb_promolist
        VALUES (HOI_LIST.IDSHOPPER, HOI_MONTH, HOI_YEAR, HOI_PROMOFLAG, HOI_USED);

        DBMS_OUTPUT.PUT_LINE('Q3. Record for IDSHOPPER: ' || HOI_LIST.IDSHOPPER || ' inserted into BB_PROMOLIST.');
        FETCH HOI_LIST_CUR INTO HOI_LIST;
    END LOOP;

    CLOSE HOI_LIST_CUR;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Q3. An error has occurred: ' || SQLERRM);
END PROMO_SHIP_SP;
/


--Testing

BEGIN
    PROMO_SHIP_SP(TO_DATE('2012-02-15', 'YYYY-MM-DD'));
END;
/
--Console Result and Comparing bb_basket
SELECT * FROM bb_promolist;


